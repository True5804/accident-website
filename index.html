<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>省道事故列表</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            font-size: 1.8em;
            margin: 10px 0;
        }
        .accident {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: space-between;
        }
        .controls > div {
            flex: 1 1 100%;
            min-width: 0;
        }
        select, input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-size: 1em;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .btn {
            flex: 1;
            padding: 8px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
            min-width: 100px;
        }
        .map-btn {
            background-color: #28a745;
            color: white;
        }
        .image-btn {
            background-color: #6c757d;
            color: white;
        }
        #map {
            height: 400px;
            width: 100%;
            margin: 15px 0;
            border-radius: 5px;
        }

        /* 響應式設計：平板（768px 以下） */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            h1 {
                font-size: 1.5em;
            }
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            .btn {
                font-size: 0.85em;
                padding: 6px;
            }
            #map {
                height: 300px;
            }
        }

        /* 響應式設計：手機（480px 以下） */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.2em;
            }
            .controls > div {
                margin-bottom: 5px;
            }
            select, input {
                padding: 6px;
                font-size: 0.9em;
            }
            .buttons {
                flex-direction: column;
                gap: 5px;
            }
            .btn {
                width: 100%;
                min-width: 0;
                font-size: 0.8em;
            }
            #map {
                height: 200px;
            }
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            position: relative;
            text-align: left;
            font-size: 1em;
        }

        .close-button {
            position: absolute;
            top: 8px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

    </style>
</head>
<body>
<div class="container">
    <details style="background-color: #f1f1f1; border: 1px solid #ccc; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
        <summary style="font-weight: bold; font-size: 1.1em; cursor: pointer;">🔎 使用說明（點此展開）</summary>
        <div style="margin-top: 10px;">
          <p>本系統旨在輔助用路人了解省道沿線近期事故發生地點與即時影像位置，提供行前路況參考。</p>
          <ol style="padding-left: 20px; margin-top: 5px;">
            <li>輸入您的「出發地」與「目的地」，點選 <strong>「計算路線」</strong>。</li>
            <li>系統會自動比對事故資料，篩選出 <strong>路線上</strong> 的事故地點。</li>
            <li>下方會列出事故列表，您可以點選 <strong>「事故地點」</strong>(假設) 查看地圖位置，或點選 <strong>「CCTV即時畫面」</strong> 查看現場畫面。</li>
          </ol>
          <p style="margin-top: 10px;">
            📍<strong>範例路線1：</strong>您可以輸入「左營高鐵站」作為出發地，「池上火車站」作為目的地，系統將顯示 2 筆事故地點。
          </p>
          <p style="margin-top: 10px;">
            📍<strong>範例路線2：</strong>您可以輸入「大溪老街」作為出發地，「淡水」作為目的地，系統將顯示 1 筆事故地點。
          </p>
          <p> 以上操作流程提供參考</p>
          <p style="margin-top: 10px;"><strong>資料來源：</strong>交通部公路總局 CCTV 資料 + 本系統整合事故影像辨識距離分析。</p>
        </div>
      </details>
    <div id="modal" class="modal-overlay">
        <div class="modal-content">
          <span class="close-button" onclick="closeModal()">×</span>
          <h2>🚧 系統使用提醒</h2>
          <p>目前因缺乏可用的實際事故影像資料集，為避免系統測試期間影響整體呈現效果，系統中的事故資訊皆為<strong>模擬資料</strong>，並非實際發生事故之位置。</p>
          <p>您點擊「CCTV即時畫面」所看到的是該路段現場之 <strong>即時監視畫面</strong>，並非事故發生當下影像。此功能設計目的是讓使用者可參考當下路況，並為未來實際應用做準備。</p>
          <button onclick="closeModal()" style="margin-top: 15px;">我了解了，進入系統</button>
        </div>
    </div>
    <div class="controls">
        <div>
            <label for="origin">出發地:</label>
            <input type="text" id="origin" placeholder="輸入出發地">
        </div>
        <div>
            <label for="destination">目的地:</label>
            <input type="text" id="destination" placeholder="輸入目的地">
        </div>
        <button class="btn" style="background-color: #007bff; color: white;" onclick="calculateRoute()">計算路線</button>
    </div>

    <div id="map"></div>
    <h1>事故清單</h1>
    <div id="accident-list">載入中...</div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6_KhyYCvjVxazjsHEJpU3q0ZV3nLJuBQ&libraries=places,geometry"></script>
<script>
    let map;
    let directionsService;
    let directionsRenderer;
    let accidentData = [];
    let accidentMarkers = []; 
    
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 8,
            center: { lat: 23.5, lng: 121 }
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);
    
        new google.maps.places.Autocomplete(document.getElementById('origin'));
        new google.maps.places.Autocomplete(document.getElementById('destination'));
    }
    
    function displayAccidents(accidents) {
        const list = document.getElementById("accident-list");
        list.innerHTML = "";

        // 移除原有的事故圖示
        accidentMarkers.forEach(marker => marker.setMap(null));
        accidentMarkers = [];

        if (accidents.length === 0) {
            list.innerHTML = "沒有符合條件的事故。";
            return;
        }

        accidents.forEach(acc => {
            // 加入清單
            const div = document.createElement("div");
            div.classList.add("accident");
            div.innerHTML = `
                <p><strong>${acc.road}</strong></p>
                <div class="buttons">
                    <button class="btn map-btn" onclick="openMap(${acc.lat}, ${acc.lon})">事故地點</button>
                    <button class="btn image-btn" onclick="openImage('${acc.link}')">CCTV即時畫面</button>
                </div>
            `;
            list.appendChild(div);

            // 在地圖上標註事故地點
            const marker = new google.maps.Marker({
                position: { lat: acc.lat, lng: acc.lon },
                map: map,
                title: acc.road,
                icon: {
                    url: "warning.png",
                    scaledSize: new google.maps.Size(24, 24)  // 調整圖示大小
                }
            });
            accidentMarkers.push(marker);
        });
    }
    
    function openMap(lat, lon) {
        window.open(`https://www.google.com/maps?q=${lat},${lon}`, "_blank");
    }
    
    function openImage(link) {
        window.open(link, "_blank");
    }
    
    function calculateRoute() {
        const origin = document.getElementById('origin').value;
        const destination = document.getElementById('destination').value;
    
        if (!origin || !destination) {
            alert('請輸入出發地和目的地');
            return;
        }
    
        directionsService.route({
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING
        }, (response, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                filterAccidentsAlongRoute(response);
            } else {
                alert('無法計算路線: ' + status);
            }
        });
    }
    
    function filterAccidentsAlongRoute(response) {
        const route = response.routes[0].overview_path;
        const path = new google.maps.Polyline({ path: route });  // 建立 polyline 路徑
        const filteredAccidents = [];

        accidentData.forEach(acc => {
            const accidentPoint = new google.maps.LatLng(acc.lat, acc.lon);

            // 使用 isLocationOnEdge 判斷事故點是否在線路附近（500m 容差）
            const isNear = google.maps.geometry.poly.isLocationOnEdge(
                accidentPoint, path, 0.005  // 0.005 度 ≈ 500 公尺
            );

            if (isNear) {
                filteredAccidents.push(acc);
            }
        });

        displayAccidents(filteredAccidents);
    }

    function closeModal() {
        document.getElementById("modal").style.display = "none";
    }

    
    window.onload = () => {
        initMap();
        Promise.all([
            fetch('data.json').then(res => {
                if (!res.ok) throw new Error(`無法載入 data.json，狀態碼: ${res.status}`);
                return res.json();
            }),
            fetch('accident_distances.json').then(res => {
                if (!res.ok) throw new Error(`無法載入 accident_distances.json，狀態碼: ${res.status}`);
                return res.json();
            })
        ])
        .then(([infoData, distanceData]) => {
            const distanceMap = {};
            distanceData.forEach(entry => {
                distanceMap[entry.name] = entry.distance;
            });

            accidentData = infoData
            .filter(entry => distanceMap[entry["檔案名稱"]])
            .map(entry => {
                const distanceText = distanceMap[entry["檔案名稱"]];
                
                // 解析 CCTV 基準里程，如 "58K+965" -> 58.965km
                const cctv = entry["CCTV位置"].replace("K+", ".").replace(/[^\d.]/g, "");
                const baseKm = parseFloat(cctv);
                
                // 新版距離格式為「xx.xm」，換算成公里並加到基準里程上
                let exactKm = baseKm;
                try {
                    const meters = parseFloat(distanceText.replace("m", ""));
                    exactKm = (baseKm + meters / 1000).toFixed(1);  // 一位小數
                } catch {}

                // 路名調整成「台17公路」格式
                const rawRoadName = (entry["道路名稱"] || "").trim();
                const roadName = rawRoadName.replace("線");

                // 方向欄位（如：南下車道 / 北上車道 / 東行車道 / 西行車道）
                const direction = entry["方向"] || "";

                return {
                    name: entry["檔案名稱"],
                    // 顯示格式：「台17公路南下車道123.4 KM」
                    road: `${roadName}${direction}${exactKm} KM`,
                    lat: entry["緯度"],
                    lon: entry["經度"],
                    link: entry["CCTV連結"],
                    region: entry["地區"] || ""
                };
            });


            displayAccidents(accidentData);
        })
        .catch(error => {
            console.error('載入資料失敗:', error);
            document.getElementById("accident-list").innerHTML = `無法載入事故資料: ${error.message}`;
        });
    };
</script>
</body>
</html>